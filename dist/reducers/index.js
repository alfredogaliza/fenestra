"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _reactRedux = require("react-redux");

var types = _interopRequireWildcard(require("../actions/types"));

var _WindowTemplate = _interopRequireDefault(require("../components/WindowTemplate"));

var _actions = require("../actions");

var _actions2 = require("fenestra/dist/actions");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var initialState = {
  winKey: 0,
  isLoading: false,
  icons: [],
  windows: [],
  startX: 0,
  startY: 0,
  startTop: 0,
  startLeft: 0,
  startWidth: 0,
  startHeight: 0,
  transformKey: null,
  transformType: null
};

function newWindow(key, props, template, templateProps) {
  var Template = (0, _reactRedux.connect)(undefined, (0, _actions2.boundTemplateActions)(key))(template);
  var top = key % 10 * 50 + 10;
  var left = key % 10 * 50 + 10;
  return {
    key: key,
    props: _objectSpread({}, _actions.DEFAULT_PROPS, {}, props, {
      style: _objectSpread({}, _actions.DEFAULT_PROPS.style, {}, props.style, {
        top: top,
        left: left
      })
    }),
    component: (0, _WindowTemplate.default)(key),
    content: _react.default.createElement(Template, templateProps)
  };
}

var reducer = function reducer() {
  var state = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : initialState;
  var action = arguments.length > 1 ? arguments[1] : undefined;

  var newState = _objectSpread({}, state);

  var target = null;
  if (action.type === types.WINDOW_TRANSFORM && state.transformKey === null) return state;

  switch (action.type) {
    case types.WINDOW_OPEN:
      var key = newState.winKey++;
      var window = newWindow(key, action.props, action.template, action.templateProps);
      newState.windows.push(window);
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        props.active = action.props.active ? window.key === key : props.active;
        props.style.zIndex = window.key === key ? 2 : 1;
        return _objectSpread({}, window, {
          props: props
        });
      });
      break;

    case types.WINDOW_CLOSE:
      newState.windows = newState.windows.filter(function (window) {
        return window.key !== action.key;
      });
      break;

    case types.WINDOW_ACTIVATE:
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        props.active = window.key === action.key;
        props.style.zIndex = window.key === action.key ? 2 : 1;
        return _objectSpread({}, window, {
          props: props
        });
      });
      break;

    case types.WINDOW_MINIMIZE:
      newState.windows = newState.windows.map(function (window) {
        if (window.key === action.key && window.props.minimizeable) {
          window.props.active = !action.minimize;
          window.props.minimized = action.minimize;
        }

        if (!action.minimize) {
          window.props.active = window.key === action.key && !action.minimize;
        }

        return window;
      });
      break;

    case types.WINDOW_MAXIMIZE:
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        props.active = window.key === action.key;
        props.minimized = window.key === action.key ? false : window.props.minimized;
        props.maximized = window.key === action.key && window.props.resizeable ? action.maximize : window.props.maximized;
        props.style.zIndex = window.key === action.key ? 2 : 1;
        return _objectSpread({}, window, {
          props: props
        });
      });
      break;

    case types.WINDOW_START_TRANSFORM:
      target = newState.windows.find(function (window) {
        return window.key === action.key;
      });
      if (target.props.maximized) break;
      newState.transformKey = action.key;
      newState.transformType = action.transformType;
      newState.startX = action.x;
      newState.startY = action.y;
      newState.startTop = target.props.style.top;
      newState.startLeft = target.props.style.left;
      newState.startWidth = target.props.style.width;
      newState.startHeight = target.props.style.height;
      break;

    case types.WINDOW_TRANSFORM:
      if (!global.window) break;
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        if (window.key === newState.transformKey) {
          var dx = action.x - newState.startX;
          var dy = action.y - newState.startY;

          if (newState.transformType === _actions.TRANSFORM_MOVE) {
            props.style.top = Math.max(0, newState.startTop + dy);
            props.style.left = Math.max(0, newState.startLeft + dx);
          } else if (newState.transformType === _actions.TRANSFORM_RESIZE) {
            props.style.width = Math.max(_actions.DEFAULT_WIDTH, newState.startWidth + dx);
            props.style.height = Math.max(_actions.DEFAULT_HEIGHT, newState.startHeight + dy);
          }
        }

        return _objectSpread({}, window, {
          props: _objectSpread({}, props, {
            style: _objectSpread({}, props.style)
          })
        });
      });
      break;

    case types.WINDOW_MINIMIZE_ALL:
      newState.windows = newState.windows.map(function (window) {
        window.props.minimized = true;
        window.props.active = false;
        return window;
      });
      break;

    case types.WINDOW_END_TRANSFORM:
      newState.transformKey = null;
      break;

    case types.SET_FOOTER:
      newState.windows = newState.windows.map(function (window) {
        if (window.key === action.key) {
          window.props.footer = action.footer;
        }

        return window;
      });
      break;

    case types.SET_LOADING:
      var loadingWindow = newState.windows.find(function (window) {
        return window.key === action.key;
      });

      if (loadingWindow) {
        loadingWindow.isLoading = action.isLoading;
      } else {
        newState.isLoading = action.isLoading;
      }

      break;

    case types.SET_DATA:
      var winKey = 0;
      var icons = action.data.icons || [];
      var windows = (action.data.windows || []).map(function (window) {
        return newWindow(winKey++, window.props, window.template, window.templateProps);
      });
      newState = _objectSpread({}, initialState, {
        winKey: winKey,
        icons: icons,
        windows: windows
      });
      break;

    default:
      break;
  }

  return newState;
};

var _default = reducer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWR1Y2Vycy9pbmRleC5qcyJdLCJuYW1lcyI6WyJpbml0aWFsU3RhdGUiLCJ3aW5LZXkiLCJpc0xvYWRpbmciLCJpY29ucyIsIndpbmRvd3MiLCJzdGFydFgiLCJzdGFydFkiLCJzdGFydFRvcCIsInN0YXJ0TGVmdCIsInN0YXJ0V2lkdGgiLCJzdGFydEhlaWdodCIsInRyYW5zZm9ybUtleSIsInRyYW5zZm9ybVR5cGUiLCJuZXdXaW5kb3ciLCJrZXkiLCJwcm9wcyIsInRlbXBsYXRlIiwidGVtcGxhdGVQcm9wcyIsIlRlbXBsYXRlIiwidW5kZWZpbmVkIiwidG9wIiwibGVmdCIsIkRFRkFVTFRfUFJPUFMiLCJzdHlsZSIsImNvbXBvbmVudCIsImNvbnRlbnQiLCJyZWR1Y2VyIiwic3RhdGUiLCJhY3Rpb24iLCJuZXdTdGF0ZSIsInRhcmdldCIsInR5cGUiLCJ0eXBlcyIsIldJTkRPV19UUkFOU0ZPUk0iLCJXSU5ET1dfT1BFTiIsIndpbmRvdyIsInB1c2giLCJtYXAiLCJhY3RpdmUiLCJ6SW5kZXgiLCJXSU5ET1dfQ0xPU0UiLCJmaWx0ZXIiLCJXSU5ET1dfQUNUSVZBVEUiLCJXSU5ET1dfTUlOSU1JWkUiLCJtaW5pbWl6ZWFibGUiLCJtaW5pbWl6ZSIsIm1pbmltaXplZCIsIldJTkRPV19NQVhJTUlaRSIsIm1heGltaXplZCIsInJlc2l6ZWFibGUiLCJtYXhpbWl6ZSIsIldJTkRPV19TVEFSVF9UUkFOU0ZPUk0iLCJmaW5kIiwieCIsInkiLCJ3aWR0aCIsImhlaWdodCIsImdsb2JhbCIsImR4IiwiZHkiLCJUUkFOU0ZPUk1fTU9WRSIsIk1hdGgiLCJtYXgiLCJUUkFOU0ZPUk1fUkVTSVpFIiwiREVGQVVMVF9XSURUSCIsIkRFRkFVTFRfSEVJR0hUIiwiV0lORE9XX01JTklNSVpFX0FMTCIsIldJTkRPV19FTkRfVFJBTlNGT1JNIiwiU0VUX0ZPT1RFUiIsImZvb3RlciIsIlNFVF9MT0FESU5HIiwibG9hZGluZ1dpbmRvdyIsIlNFVF9E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QUk7QUFDdEQsZUFBT3RCLFNBQVMsQ0FBQ1osTUFBTSxFQUFQLEVBQVdrQyxNQUFNLENBQUNwQixLQUFsQixFQUF5Qm9CLE1BQU0sQ0FBQ25CLFFBQWhDLEVBQTBDbUIsTUFBTSxDQUFDbEIsYUFBakQsQ0FBaEI7QUFDSCxPQUZlLENBQWhCO0FBSUFZLE1BQUFBLFFBQVEscUJBQ0Q3QixZQURDO0FBRUpDLFFBQUFBLE1BQU0sRUFBTkEsTUFGSTtBQUdKRSxRQUFBQSxLQUFLLEVBQUxBLEtBSEk7QUFJSkMsUUFBQUEsT0FBTyxFQUFQQTtBQUpJLFFBQVI7QUFNQTs7QUFFSjtBQUNJO0FBbklSOztBQXNJQSxTQUFPeUIsUUFBUDtBQUVILENBL0lEOztlQWlKZUgsTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCc7XG5pbXBvcnQgeyBjb25uZWN0IH0gZnJvbSAncmVhY3QtcmVkdXgnO1xuXG5pbXBvcnQgKiBhcyB0eXBlcyBmcm9tICcuLi9hY3Rpb25zL3R5cGVzJztcbmltcG9ydCBXaW5kb3dUZW1wbGF0ZSBmcm9tICcuLi9jb21wb25lbnRzL1dpbmRvd1RlbXBsYXRlJztcbmltcG9ydCB7XG4gICAgVFJBTlNGT1JNX01PVkUsXG4gICAgVFJBTlNGT1JNX1JFU0laRSxcbiAgICBERUZBVUxUX1BST1BTLFxuICAgIGJvdW5kVGVtcGxhdGVQcm9wcyxcbiAgICBERUZBVUxUX1dJRFRILFxuICAgIERFRkFVTFRfSEVJR0hUXG59IGZyb20gJy4uL2FjdGlvbnMnO1xuaW1wb3J0IHsgYm91bmRUZW1wbGF0ZUFjdGlvbnMgfSBmcm9tICdmZW5lc3RyYS9kaXN0L2FjdGlvbnMnO1xuXG5jb25zdCBpbml0aWFsU3RhdGUgPSB7XG4gICAgd2luS2V5OiAwLFxuICAgIGlzTG9hZGluZzogZmFsc2UsXG4gICAgaWNvbnM6IFtdLFxuICAgIHdpbmRvd3M6IFtdLFxuICAgIHN0YXJ0WDogMCxcbiAgICBzdGFydFk6IDAsXG4gICAgc3RhcnRUb3A6IDAsXG4gICAgc3RhcnRMZWZ0OiAwLFxuICAgIHN0YXJ0V2lkdGg6IDAsXG4gICAgc3RhcnRIZWlnaHQ6IDAsXG4gICAgdHJhbnNmb3JtS2V5OiBudWxsLFxuICAgIHRyYW5zZm9ybVR5cGU6IG51bGxcbn1cblxuZnVuY3Rpb24gbmV3V2luZG93KGtleSwgcHJvcHMsIHRlbXBsYXRlLCB0ZW1wbGF0ZVByb3BzKSB7XG5cbiAgICBjb25zdCBUZW1wbGF0ZSA9IGNvbm5lY3QodW5kZWZpbmVkLCBib3VuZFRlbXBsYXRlQWN0aW9ucyhrZXkpKSh0ZW1wbGF0ZSk7XG5cbiAgICBjb25zdCB0b3AgPSAoa2V5ICUgMTApICogNTAgKyAxMDtcbiAgICBjb25zdCBsZWZ0ID0gKGtleSAlIDEwKSAqIDUwICsgMTA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgICBrZXksXG4gICAgICAgIHByb3BzOiB7XG4gICAgICAgICAgICAuLi5ERUZBVUxUX1BST1BTLFxuICAgICAgICAgICAgLi4ucHJvcHMsXG4gICAgICAgICAgICBzdHlsZToge1xuICAgICAgICAgICAgICAgIC4uLkRFRkFVTFRfUFJPUFMuc3R5bGUsXG4gICAgICAgICAgICAgICAgLi4ucHJvcHMuc3R5bGUsXG4gICAgICAgICAgICAgICAgdG9wLCBsZWZ0XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIGNvbXBvbmVudDogV2luZG93VGVtcGxhdGUoa2V5KSxcbiAgICAgICAgY29udGVudDogPFRlbXBsYXRlIHsuLi50ZW1wbGF0ZVByb3BzfSAvPlxuICAgIH07XG59XG5cbmNvbnN0IHJlZHVjZXIgPSAoc3RhdGUgPSBpbml0aWFsU3RhdGUsIGFjdGlvbikgPT4ge1xuXG4gICAgdmFyIG5ld1N0YXRlID0geyAuLi5zdGF0ZSB9O1xuICAgIHZhciB0YXJnZXQgPSBudWxsO1xuXG4gICAgaWYgKGFjdGlvbi50eXBlID09PSB0eXBlcy5XSU5ET1dfVFJBTlNGT1JNICYmIHN0YXRlLnRyYW5zZm9ybUtleSA9PT0gbnVsbCkgcmV0dXJuIHN0YXRlO1xuXG4gICAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19PUEVOOlxuXG4gICAgICAgICAgICBjb25zdCBrZXkgPSBuZXdTdGF0ZS53aW5LZXkrKztcbiAgICAgICAgICAgIGNvbnN0IHdpbmRvdyA9IG5ld1dpbmRvdyhrZXksIGFjdGlvbi5wcm9wcywgYWN0aW9uLnRlbXBsYXRlLCBhY3Rpb24udGVtcGxhdGVQcm9wcyk7XG5cbiAgICAgICAgICAgIG5ld1N0YXRlLndpbmRvd3MucHVzaCh3aW5kb3cpO1xuXG4gICAgICAgICAgICBuZXdTdGF0ZS53aW5kb3dzID0gbmV3U3RhdGUud2luZG93cy5tYXAod2luZG93ID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7IC4uLndpbmRvdy5wcm9wcywgc3R5bGU6IHsgLi4ud2luZG93LnByb3BzLnN0eWxlIH0gfTtcbiAgICAgICAgICAgICAgICBwcm9wcy5hY3RpdmUgPSBhY3Rpb24ucHJvcHMuYWN0aXZlID8gKHdpbmRvdy5rZXkgPT09IGtleSkgOiBwcm9wcy5hY3RpdmU7XG4gICAgICAgICAgICAgICAgcHJvcHMuc3R5bGUuekluZGV4ID0gKHdpbmRvdy5rZXkgPT09IGtleSkgPyAyIDogMTtcbiAgICAgICAgICAgICAgICByZXR1cm4geyAuLi53aW5kb3csIHByb3BzIH07XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgdHlwZXMuV0lORE9XX0NMT1NFOlxuICAgICAgICAgICAgbmV3U3RhdGUud2luZG93cyA9IG5ld1N0YXRlLndpbmRvd3MuZmlsdGVyKHdpbmRvdyA9PiB3aW5kb3cua2V5ICE9PSBhY3Rpb24ua2V5KTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgdHlwZXMuV0lORE9XX0FDVElWQVRFOlxuICAgICAgICAgICAgbmV3U3RhdGUud2luZG93cyA9IG5ld1N0YXRlLndpbmRvd3MubWFwKHdpbmRvdyA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIHByb3BzID0geyAuLi53aW5kb3cucHJvcHMsIHN0eWxlOiB7IC4uLndpbmRvdy5wcm9wcy5zdHlsZSB9IH07XG4gICAgICAgICAgICAgICAgcHJvcHMuYWN0aXZlID0gKHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkpO1xuICAgICAgICAgICAgICAgIHByb3BzLnN0eWxlLnpJbmRleCA9ICh3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5KSA/IDIgOiAxO1xuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLndpbmRvdywgcHJvcHMgfTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSB0eXBlcy5XSU5ET1dfTUlOSU1JWkU6XG4gICAgICAgICAgICBuZXdTdGF0ZS53aW5kb3dzID0gbmV3U3RhdGUud2luZG93cy5tYXAod2luZG93ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LmtleSA9PT0gYWN0aW9uLmtleSAmJiB3aW5kb3cucHJvcHMubWluaW1pemVhYmxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5wcm9wcy5hY3RpdmUgPSAhYWN0aW9uLm1pbmltaXplO1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cucHJvcHMubWluaW1pemVkID0gYWN0aW9uLm1pbmltaXplO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIWFjdGlvbi5taW5pbWl6ZSkge1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cucHJvcHMuYWN0aXZlID0gKHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkgJiYgIWFjdGlvbi5taW5pbWl6ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB3aW5kb3c7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19NQVhJTUlaRTpcbiAgICAgICAgICAgIG5ld1N0YXRlLndpbmRvd3MgPSBuZXdTdGF0ZS53aW5kb3dzLm1hcCh3aW5kb3cgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsgLi4ud2luZG93LnByb3BzLCBzdHlsZTogeyAuLi53aW5kb3cucHJvcHMuc3R5bGUgfSB9O1xuICAgICAgICAgICAgICAgIHByb3BzLmFjdGl2ZSA9ICh3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5KTtcbiAgICAgICAgICAgICAgICBwcm9wcy5taW5pbWl6ZWQgPSAod2luZG93LmtleSA9PT0gYWN0aW9uLmtleSkgPyBmYWxzZSA6IHdpbmRvdy5wcm9wcy5taW5pbWl6ZWQ7XG4gICAgICAgICAgICAgICAgcHJvcHMubWF4aW1pemVkID0gKHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkgJiYgd2luZG93LnByb3BzLnJlc2l6ZWFibGUpID8gYWN0aW9uLm1heGltaXplIDogd2luZG93LnByb3BzLm1heGltaXplZDtcbiAgICAgICAgICAgICAgICBwcm9wcy5zdHlsZS56SW5kZXggPSAod2luZG93LmtleSA9PT0gYWN0aW9uLmtleSkgPyAyIDogMTtcbiAgICAgICAgICAgICAgICByZXR1cm4geyAuLi53aW5kb3csIHByb3BzIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19TVEFSVF9UUkFOU0ZPUk06XG4gICAgICAgICAgICB0YXJnZXQgPSBuZXdTdGF0ZS53aW5kb3dzLmZpbmQod2luZG93ID0+IHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkpO1xuICAgICAgICAgICAgaWYgKHRhcmdldC5wcm9wcy5tYXhpbWl6ZWQpIGJyZWFrO1xuICAgICAgICAgICAgbmV3U3RhdGUudHJhbnNmb3JtS2V5ID0gYWN0aW9uLmtleTtcbiAgICAgICAgICAgIG5ld1N0YXRlLnRyYW5zZm9ybVR5cGUgPSBhY3Rpb24udHJhbnNmb3JtVHlwZTtcbiAgICAgICAgICAgIG5ld1N0YXRlLnN0YXJ0WCA9IGFjdGlvbi54O1xuICAgICAgICAgICAgbmV3U3RhdGUuc3RhcnRZID0gYWN0aW9uLnk7XG4gICAgICAgICAgICBuZXdTdGF0ZS5zdGFydFRvcCA9IHRhcmdldC5wcm9wcy5zdHlsZS50b3A7XG4gICAgICAgICAgICBuZXdTdGF0ZS5zdGFydExlZnQgPSB0YXJnZXQucHJvcHMuc3R5bGUubGVmdDtcbiAgICAgICAgICAgIG5ld1N0YXRlLnN0YXJ0V2lkdGggPSB0YXJnZXQucHJvcHMuc3R5bGUud2lkdGg7XG4gICAgICAgICAgICBuZXdTdGF0ZS5zdGFydEhlaWdodCA9IHRhcmdldC5wcm9wcy5zdHlsZS5oZWlnaHQ7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19UUkFOU0ZPUk06XG4gICAgICAgICAgICBpZiAoIWdsb2JhbC53aW5kb3cpIGJyZWFrO1xuICAgICAgICAgICAgbmV3U3RhdGUud2luZG93cyA9IG5ld1N0YXRlLndpbmRvd3MubWFwKHdpbmRvdyA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIHByb3BzID0geyAuLi53aW5kb3cucHJvcHMsIHN0eWxlOiB7IC4uLndpbmRvdy5wcm9wcy5zdHlsZSB9IH07XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5rZXkgPT09IG5ld1N0YXRlLnRyYW5zZm9ybUtleSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkeCA9IGFjdGlvbi54IC0gbmV3U3RhdGUuc3RhcnRYO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBkeSA9IGFjdGlvbi55IC0gbmV3U3RhdGUuc3RhcnRZO1xuICAgICAgICAgICAgICAgICAgICBpZiAobmV3U3RhdGUudHJhbnNmb3JtVHlwZSA9PT0gVFJBTlNGT1JNX01PVkUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLnN0eWxlLnRvcCA9IE1hdGgubWF4KDAsIG5ld1N0YXRlLnN0YXJ0VG9wICsgZHkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuc3R5bGUubGVmdCA9IE1hdGgubWF4KDAsIG5ld1N0YXRlLnN0YXJ0TGVmdCArIGR4KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChuZXdTdGF0ZS50cmFuc2Zvcm1UeXBlID09PSBUUkFOU0ZPUk1fUkVTSVpFKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5zdHlsZS53aWR0aCA9IE1hdGgubWF4KERFRkFVTFRfV0lEVEgsIG5ld1N0YXRlLnN0YXJ0V2lkdGggKyBkeCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5zdHlsZS5oZWlnaHQgPSBNYXRoLm1heChERUZBVUxUX0hFSUdIVCwgbmV3U3RhdGUuc3RhcnRIZWlnaHQgKyBkeSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgLi4ud2luZG93LCBwcm9wczogeyAuLi5wcm9wcywgc3R5bGU6IHsgLi4ucHJvcHMuc3R5bGUgfSB9IH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgdHlwZXMuV0lORE9XX01JTklNSVpFX0FMTDpcbiAgICAgICAgICAgIG5ld1N0YXRlLndpbmRvd3MgPSBuZXdTdGF0ZS53aW5kb3dzLm1hcCh3aW5kb3cgPT4ge1xuICAgICAgICAgICAgICAgIHdpbmRvdy5wcm9wcy5taW5pbWl6ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHdpbmRvdy5wcm9wcy5hY3RpdmUgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19FTkRfVFJBTlNGT1JNOlxuICAgICAgICAgICAgbmV3U3RhdGUudHJhbnNmb3JtS2V5ID0gbnVsbDtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgdHlwZXMuU0VUX0ZPT1RFUjpcbiAgICAgICAgICAgIG5ld1N0YXRlLndpbmRvd3MgPSBuZXdTdGF0ZS53aW5kb3dzLm1hcCh3aW5kb3cgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5KSB7XG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5wcm9wcy5mb290ZXIgPSBhY3Rpb24uZm9vdGVyO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIHR5cGVzLlNFVF9MT0FESU5HOlxuICAgICAgICAgICAgdmFyIGxvYWRpbmdXaW5kb3cgPSBuZXdTdGF0ZS53aW5kb3dzLmZpbmQod2luZG93ID0+IHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkpO1xuXG4gICAgICAgICAgICBpZiAobG9hZGluZ1dpbmRvdykge1xuICAgICAgICAgICAgICAgIGxvYWRpbmdXaW5kb3cuaXNMb2FkaW5nID0gYWN0aW9uLmlzTG9hZGluZztcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV3U3RhdGUuaXNMb2FkaW5nID0gYWN0aW9uLmlzTG9hZGluZztcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSB0eXBlcy5TRVRfREFUQTpcbiAgICAgICAgICAgIHZhciB3aW5LZXkgPSAwO1xuICAgICAgICAgICAgY29uc3QgaWNvbnMgPSAoYWN0aW9uLmRhdGEuaWNvbnMgfHwgW10pO1xuICAgICAgICAgICAgY29uc3Qgd2luZG93cyA9IChhY3Rpb24uZGF0YS53aW5kb3dzIHx8IFtdKS5tYXAod2luZG93ID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3V2luZG93KHdpbktleSsrLCB3aW5kb3cucHJvcHMsIHdpbmRvdy50ZW1wbGF0ZSwgd2luZG93LnRlbXBsYXRlUHJvcHMpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIG5ld1N0YXRlID0ge1xuICAgICAgICAgICAgICAgIC4uLmluaXRpYWxTdGF0ZSxcbiAgICAgICAgICAgICAgICB3aW5LZXksXG4gICAgICAgICAgICAgICAgaWNvbnMsXG4gICAgICAgICAgICAgICAgd2luZG93c1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4gbmV3U3RhdGU7XG5cbn1cblxuZXhwb3J0IGRlZmF1bHQgcmVkdWNlcjsiXX0=