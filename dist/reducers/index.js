"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _react = _interopRequireDefault(require("react"));

var _reactRedux = require("react-redux");

var types = _interopRequireWildcard(require("../actions/types"));

var _WindowTemplate = _interopRequireDefault(require("../components/WindowTemplate"));

var _actions = require("../actions");

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = Object.defineProperty && Object.getOwnPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : {}; if (desc.get || desc.set) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var initialState = {
  winKey: 0,
  isLoading: false,
  icons: [],
  windows: [],
  startX: 0,
  startY: 0,
  startTop: 0,
  startLeft: 0,
  startWidth: 0,
  startHeight: 0,
  transformKey: null,
  transformType: null
};

function newWindow(key, props, template, templateProps) {
  var Template = (0, _reactRedux.connect)((0, _actions.boundTemplateProps)(key), boundTemplateActions(key))(template);
  var top = key % 10 * 50 + 10;
  var left = key % 10 * 50 + 10;
  return {
    key: key,
    props: _objectSpread({}, _actions.DEFAULT_PROPS, {}, props, {
      style: _objectSpread({}, _actions.DEFAULT_PROPS.style, {}, props.style, {
        top: top,
        left: left
      })
    }),
    component: (0, _WindowTemplate.default)(key),
    content: _react.default.createElement(Template, templateProps)
  };
}

var reducer = function reducer() {
  var state = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : initialState;
  var action = arguments.length > 1 ? arguments[1] : undefined;

  var newState = _objectSpread({}, state);

  var target = null;
  if (action.type === types.WINDOW_TRANSFORM && state.transformKey === null) return state;

  switch (action.type) {
    case types.WINDOW_OPEN:
      var key = newState.winKey++;
      var window = newWindow(key, action.props, action.template, action.templateProps);
      newState.windows.push(window);
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        props.active = action.props.active ? window.key === key : props.active;
        props.style.zIndex = window.key === key ? 2 : 1;
        return _objectSpread({}, window, {
          props: props
        });
      });
      break;

    case types.WINDOW_CLOSE:
      newState.windows = newState.windows.filter(function (window) {
        return window.key !== action.key;
      });
      break;

    case types.WINDOW_ACTIVATE:
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        props.active = window.key === action.key;
        props.style.zIndex = window.key === action.key ? 2 : 1;
        return _objectSpread({}, window, {
          props: props
        });
      });
      break;

    case types.WINDOW_MINIMIZE:
      newState.windows = newState.windows.map(function (window) {
        if (window.key === action.key && window.props.minimizeable) {
          window.props.active = !action.minimize;
          window.props.minimized = action.minimize;
        }

        if (!action.minimize) {
          window.props.active = window.key === action.key && !action.minimize;
        }

        return window;
      });
      break;

    case types.WINDOW_MAXIMIZE:
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        props.active = window.key === action.key;
        props.minimized = window.key === action.key ? false : window.props.minimized;
        props.maximized = window.key === action.key && window.props.resizeable ? action.maximize : window.props.maximized;
        props.style.zIndex = window.key === action.key ? 2 : 1;
        return _objectSpread({}, window, {
          props: props
        });
      });
      break;

    case types.WINDOW_START_TRANSFORM:
      target = newState.windows.find(function (window) {
        return window.key === action.key;
      });
      if (target.props.maximized) break;
      newState.transformKey = action.key;
      newState.transformType = action.transformType;
      newState.startX = action.x;
      newState.startY = action.y;
      newState.startTop = target.props.style.top;
      newState.startLeft = target.props.style.left;
      newState.startWidth = target.props.style.width;
      newState.startHeight = target.props.style.height;
      break;

    case types.WINDOW_TRANSFORM:
      if (!global.window) break;
      newState.windows = newState.windows.map(function (window) {
        var props = _objectSpread({}, window.props, {
          style: _objectSpread({}, window.props.style)
        });

        if (window.key === newState.transformKey) {
          var dx = action.x - newState.startX;
          var dy = action.y - newState.startY;

          if (newState.transformType === _actions.TRANSFORM_MOVE) {
            props.style.top = Math.max(0, newState.startTop + dy);
            props.style.left = Math.max(0, newState.startLeft + dx);
          } else if (newState.transformType === _actions.TRANSFORM_RESIZE) {
            props.style.width = Math.max(_actions.DEFAULT_WIDTH, newState.startWidth + dx);
            props.style.height = Math.max(_actions.DEFAULT_HEIGHT, newState.startHeight + dy);
          }
        }

        return _objectSpread({}, window, {
          props: _objectSpread({}, props, {
            style: _objectSpread({}, props.style)
          })
        });
      });
      break;

    case types.WINDOW_MINIMIZE_ALL:
      newState.windows = newState.windows.map(function (window) {
        window.props.minimized = true;
        window.props.active = false;
        return window;
      });
      break;

    case types.WINDOW_END_TRANSFORM:
      newState.transformKey = null;
      break;

    case types.SET_FOOTER:
      newState.windows = newState.windows.map(function (window) {
        if (window.key === action.key) {
          window.props.footer = action.footer;
        }

        return window;
      });
      break;

    case types.SET_LOADING:
      var loadingWindow = newState.windows.find(function (window) {
        return window.key === action.key;
      });

      if (loadingWindow) {
        loadingWindow.isLoading = action.isLoading;
      } else {
        newState.isLoading = action.isLoading;
      }

      break;

    case types.SET_DATA:
      var winKey = 0;
      var icons = action.data.icons || [];
      var windows = (action.data.windows || []).map(function (window) {
        return newWindow(winKey++, window.props, window.template, window.templateProps);
      });
      newState = _objectSpread({}, initialState, {
        winKey: winKey,
        icons: icons,
        windows: windows
      });
      break;

    default:
      break;
  }

  return newState;
};

var _default = reducer;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9yZWR1Y2Vycy9pbmRleC5qcyJdLCJuYW1lcyI6WyJpbml0aWFsU3RhdGUiLCJ3aW5LZXkiLCJpc0xvYWRpbmciLCJpY29ucyIsIndpbmRvd3MiLCJzdGFydFgiLCJzdGFydFkiLCJzdGFydFRvcCIsInN0YXJ0TGVmdCIsInN0YXJ0V2lkdGgiLCJzdGFydEhlaWdodCIsInRyYW5zZm9ybUtleSIsInRyYW5zZm9ybVR5cGUiLCJuZXdXaW5kb3ciLCJrZXkiLCJwcm9wcyIsInRlbXBsYXRlIiwidGVtcGxhdGVQcm9wcyIsIlRlbXBsYXRlIiwiYm91bmRUZW1wbGF0ZUFjdGlvbnMiLCJ0b3AiLCJsZWZ0IiwiREVGQVVMVF9QUk9QUyIsInN0eWxlIiwiY29tcG9uZW50IiwiY29udGVudCIsInJlZHVjZXIiLCJzdGF0ZSIsImFjdGlvbiIsIm5ld1N0YXRlIiwidGFyZ2V0IiwidHlwZSIsInR5cGVzIiwiV0lORE9XX1RSQU5TRk9STSIsIldJTkRPV19PUEVOIiwid2luZG93IiwicHVzaCIsIm1hcCIsImFjdGl2ZSIsInpJbmRleCIsIldJTkRPV19DTE9TRSIsImZpbHRlciIsIldJTkRPV19BQ1RJVkFURSIsIldJTkRPV19NSU5JTUlaRSIsIm1pbmltaXplYWJsZSIsIm1pbmltaXplIiwibWluaW1pemVkIiwiV0lORE9XX01BWElNSVpFIiwibWF4aW1pemVkIiwicmVzaXplYWJsZSIsIm1heGltaXplIiwiV0lORE9XX1NUQVJUX1RSQU5TRk9STSIsImZpbmQiLCJ4IiwieSIsIndpZHRoIiwiaGVpZ2h0IiwiZ2xvYmFsIiwiZHgiLCJkeSIsIlRSQU5TRk9STV9NT1ZFIiwiTWF0aCIsIm1heCIsIlRSQU5TRk9STV9SRVNJWkUiLCJERUZBVUxUX1dJRFRIIiwiREVGQVVMVF9IRUlHSFQiLCJXSU5ET1dfTUlOSU1JWkVfQUxMIiwiV0lORE9XX0VORF9UUkFOU0ZPUk0iLCJTRVRfRk9PVEVSIiwiZm9vdGVyIiwiU0VUX0xPQURJTkciLCJsb2FkaW5nV2lu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QTVCLENBQWdDLFVBQUFGLE1BQU0sRUFBSTtBQUN0RCxlQUFPdEIsU0FBUyxDQUFDWixNQUFNLEVBQVAsRUFBV2tDLE1BQU0sQ0FBQ3BCLEtBQWxCLEVBQXlCb0IsTUFBTSxDQUFDbkIsUUFBaEMsRUFBMENtQixNQUFNLENBQUNsQixhQUFqRCxDQUFoQjtBQUNILE9BRmUsQ0FBaEI7QUFJQVksTUFBQUEsUUFBUSxxQkFDRDdCLFlBREM7QUFFSkMsUUFBQUEsTUFBTSxFQUFOQSxNQUZJO0FBR0pFLFFBQUFBLEtBQUssRUFBTEEsS0FISTtBQUlKQyxRQUFBQSxPQUFPLEVBQVBBO0FBSkksUUFBUjtBQU1BOztBQUVKO0FBQ0k7QUFuSVI7O0FBc0lBLFNBQU95QixRQUFQO0FBRUgsQ0EvSUQ7O2VBaUplSCxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IGNvbm5lY3QgfSBmcm9tICdyZWFjdC1yZWR1eCc7XG5cbmltcG9ydCAqIGFzIHR5cGVzIGZyb20gJy4uL2FjdGlvbnMvdHlwZXMnO1xuaW1wb3J0IFdpbmRvd1RlbXBsYXRlIGZyb20gJy4uL2NvbXBvbmVudHMvV2luZG93VGVtcGxhdGUnO1xuaW1wb3J0IHtcbiAgICBUUkFOU0ZPUk1fTU9WRSxcbiAgICBUUkFOU0ZPUk1fUkVTSVpFLFxuICAgIERFRkFVTFRfUFJPUFMsXG4gICAgYm91bmRUZW1wbGF0ZVByb3BzLFxuICAgIERFRkFVTFRfV0lEVEgsXG4gICAgREVGQVVMVF9IRUlHSFRcbn0gZnJvbSAnLi4vYWN0aW9ucyc7XG5cbmNvbnN0IGluaXRpYWxTdGF0ZSA9IHtcbiAgICB3aW5LZXk6IDAsXG4gICAgaXNMb2FkaW5nOiBmYWxzZSxcbiAgICBpY29uczogW10sXG4gICAgd2luZG93czogW10sXG4gICAgc3RhcnRYOiAwLFxuICAgIHN0YXJ0WTogMCxcbiAgICBzdGFydFRvcDogMCxcbiAgICBzdGFydExlZnQ6IDAsXG4gICAgc3RhcnRXaWR0aDogMCxcbiAgICBzdGFydEhlaWdodDogMCxcbiAgICB0cmFuc2Zvcm1LZXk6IG51bGwsXG4gICAgdHJhbnNmb3JtVHlwZTogbnVsbFxufVxuXG5mdW5jdGlvbiBuZXdXaW5kb3coa2V5LCBwcm9wcywgdGVtcGxhdGUsIHRlbXBsYXRlUHJvcHMpIHtcblxuICAgIGNvbnN0IFRlbXBsYXRlID0gY29ubmVjdChib3VuZFRlbXBsYXRlUHJvcHMoa2V5KSwgYm91bmRUZW1wbGF0ZUFjdGlvbnMoa2V5KSkodGVtcGxhdGUpO1xuXG4gICAgY29uc3QgdG9wID0gKGtleSAlIDEwKSAqIDUwICsgMTA7XG4gICAgY29uc3QgbGVmdCA9IChrZXkgJSAxMCkgKiA1MCArIDEwO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgICAga2V5LFxuICAgICAgICBwcm9wczoge1xuICAgICAgICAgICAgLi4uREVGQVVMVF9QUk9QUyxcbiAgICAgICAgICAgIC4uLnByb3BzLFxuICAgICAgICAgICAgc3R5bGU6IHtcbiAgICAgICAgICAgICAgICAuLi5ERUZBVUxUX1BST1BTLnN0eWxlLFxuICAgICAgICAgICAgICAgIC4uLnByb3BzLnN0eWxlLFxuICAgICAgICAgICAgICAgIHRvcCwgbGVmdFxuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBjb21wb25lbnQ6IFdpbmRvd1RlbXBsYXRlKGtleSksXG4gICAgICAgIGNvbnRlbnQ6IDxUZW1wbGF0ZSB7Li4udGVtcGxhdGVQcm9wc30gLz5cbiAgICB9O1xufVxuXG5jb25zdCByZWR1Y2VyID0gKHN0YXRlID0gaW5pdGlhbFN0YXRlLCBhY3Rpb24pID0+IHtcblxuICAgIHZhciBuZXdTdGF0ZSA9IHsgLi4uc3RhdGUgfTtcbiAgICB2YXIgdGFyZ2V0ID0gbnVsbDtcblxuICAgIGlmIChhY3Rpb24udHlwZSA9PT0gdHlwZXMuV0lORE9XX1RSQU5TRk9STSAmJiBzdGF0ZS50cmFuc2Zvcm1LZXkgPT09IG51bGwpIHJldHVybiBzdGF0ZTtcblxuICAgIHN3aXRjaCAoYWN0aW9uLnR5cGUpIHtcbiAgICAgICAgY2FzZSB0eXBlcy5XSU5ET1dfT1BFTjpcblxuICAgICAgICAgICAgY29uc3Qga2V5ID0gbmV3U3RhdGUud2luS2V5Kys7XG4gICAgICAgICAgICBjb25zdCB3aW5kb3cgPSBuZXdXaW5kb3coa2V5LCBhY3Rpb24ucHJvcHMsIGFjdGlvbi50ZW1wbGF0ZSwgYWN0aW9uLnRlbXBsYXRlUHJvcHMpO1xuXG4gICAgICAgICAgICBuZXdTdGF0ZS53aW5kb3dzLnB1c2god2luZG93KTtcblxuICAgICAgICAgICAgbmV3U3RhdGUud2luZG93cyA9IG5ld1N0YXRlLndpbmRvd3MubWFwKHdpbmRvdyA9PiB7XG4gICAgICAgICAgICAgICAgdmFyIHByb3BzID0geyAuLi53aW5kb3cucHJvcHMsIHN0eWxlOiB7IC4uLndpbmRvdy5wcm9wcy5zdHlsZSB9IH07XG4gICAgICAgICAgICAgICAgcHJvcHMuYWN0aXZlID0gYWN0aW9uLnByb3BzLmFjdGl2ZSA/ICh3aW5kb3cua2V5ID09PSBrZXkpIDogcHJvcHMuYWN0aXZlO1xuICAgICAgICAgICAgICAgIHByb3BzLnN0eWxlLnpJbmRleCA9ICh3aW5kb3cua2V5ID09PSBrZXkpID8gMiA6IDE7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgLi4ud2luZG93LCBwcm9wcyB9O1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19DTE9TRTpcbiAgICAgICAgICAgIG5ld1N0YXRlLndpbmRvd3MgPSBuZXdTdGF0ZS53aW5kb3dzLmZpbHRlcih3aW5kb3cgPT4gd2luZG93LmtleSAhPT0gYWN0aW9uLmtleSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19BQ1RJVkFURTpcbiAgICAgICAgICAgIG5ld1N0YXRlLndpbmRvd3MgPSBuZXdTdGF0ZS53aW5kb3dzLm1hcCh3aW5kb3cgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsgLi4ud2luZG93LnByb3BzLCBzdHlsZTogeyAuLi53aW5kb3cucHJvcHMuc3R5bGUgfSB9O1xuICAgICAgICAgICAgICAgIHByb3BzLmFjdGl2ZSA9ICh3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5KTtcbiAgICAgICAgICAgICAgICBwcm9wcy5zdHlsZS56SW5kZXggPSAod2luZG93LmtleSA9PT0gYWN0aW9uLmtleSkgPyAyIDogMTtcbiAgICAgICAgICAgICAgICByZXR1cm4geyAuLi53aW5kb3csIHByb3BzIH07XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgdHlwZXMuV0lORE9XX01JTklNSVpFOlxuICAgICAgICAgICAgbmV3U3RhdGUud2luZG93cyA9IG5ld1N0YXRlLndpbmRvd3MubWFwKHdpbmRvdyA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkgJiYgd2luZG93LnByb3BzLm1pbmltaXplYWJsZSkge1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cucHJvcHMuYWN0aXZlID0gIWFjdGlvbi5taW5pbWl6ZTtcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LnByb3BzLm1pbmltaXplZCA9IGFjdGlvbi5taW5pbWl6ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKCFhY3Rpb24ubWluaW1pemUpIHtcbiAgICAgICAgICAgICAgICAgICAgd2luZG93LnByb3BzLmFjdGl2ZSA9ICh3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5ICYmICFhY3Rpb24ubWluaW1pemUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gd2luZG93O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSB0eXBlcy5XSU5ET1dfTUFYSU1JWkU6XG4gICAgICAgICAgICBuZXdTdGF0ZS53aW5kb3dzID0gbmV3U3RhdGUud2luZG93cy5tYXAod2luZG93ID0+IHtcbiAgICAgICAgICAgICAgICB2YXIgcHJvcHMgPSB7IC4uLndpbmRvdy5wcm9wcywgc3R5bGU6IHsgLi4ud2luZG93LnByb3BzLnN0eWxlIH0gfTtcbiAgICAgICAgICAgICAgICBwcm9wcy5hY3RpdmUgPSAod2luZG93LmtleSA9PT0gYWN0aW9uLmtleSk7XG4gICAgICAgICAgICAgICAgcHJvcHMubWluaW1pemVkID0gKHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkpID8gZmFsc2UgOiB3aW5kb3cucHJvcHMubWluaW1pemVkO1xuICAgICAgICAgICAgICAgIHByb3BzLm1heGltaXplZCA9ICh3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5ICYmIHdpbmRvdy5wcm9wcy5yZXNpemVhYmxlKSA/IGFjdGlvbi5tYXhpbWl6ZSA6IHdpbmRvdy5wcm9wcy5tYXhpbWl6ZWQ7XG4gICAgICAgICAgICAgICAgcHJvcHMuc3R5bGUuekluZGV4ID0gKHdpbmRvdy5rZXkgPT09IGFjdGlvbi5rZXkpID8gMiA6IDE7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgLi4ud2luZG93LCBwcm9wcyB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSB0eXBlcy5XSU5ET1dfU1RBUlRfVFJBTlNGT1JNOlxuICAgICAgICAgICAgdGFyZ2V0ID0gbmV3U3RhdGUud2luZG93cy5maW5kKHdpbmRvdyA9PiB3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5KTtcbiAgICAgICAgICAgIGlmICh0YXJnZXQucHJvcHMubWF4aW1pemVkKSBicmVhaztcbiAgICAgICAgICAgIG5ld1N0YXRlLnRyYW5zZm9ybUtleSA9IGFjdGlvbi5rZXk7XG4gICAgICAgICAgICBuZXdTdGF0ZS50cmFuc2Zvcm1UeXBlID0gYWN0aW9uLnRyYW5zZm9ybVR5cGU7XG4gICAgICAgICAgICBuZXdTdGF0ZS5zdGFydFggPSBhY3Rpb24ueDtcbiAgICAgICAgICAgIG5ld1N0YXRlLnN0YXJ0WSA9IGFjdGlvbi55O1xuICAgICAgICAgICAgbmV3U3RhdGUuc3RhcnRUb3AgPSB0YXJnZXQucHJvcHMuc3R5bGUudG9wO1xuICAgICAgICAgICAgbmV3U3RhdGUuc3RhcnRMZWZ0ID0gdGFyZ2V0LnByb3BzLnN0eWxlLmxlZnQ7XG4gICAgICAgICAgICBuZXdTdGF0ZS5zdGFydFdpZHRoID0gdGFyZ2V0LnByb3BzLnN0eWxlLndpZHRoO1xuICAgICAgICAgICAgbmV3U3RhdGUuc3RhcnRIZWlnaHQgPSB0YXJnZXQucHJvcHMuc3R5bGUuaGVpZ2h0O1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSB0eXBlcy5XSU5ET1dfVFJBTlNGT1JNOlxuICAgICAgICAgICAgaWYgKCFnbG9iYWwud2luZG93KSBicmVhaztcbiAgICAgICAgICAgIG5ld1N0YXRlLndpbmRvd3MgPSBuZXdTdGF0ZS53aW5kb3dzLm1hcCh3aW5kb3cgPT4ge1xuICAgICAgICAgICAgICAgIHZhciBwcm9wcyA9IHsgLi4ud2luZG93LnByb3BzLCBzdHlsZTogeyAuLi53aW5kb3cucHJvcHMuc3R5bGUgfSB9O1xuICAgICAgICAgICAgICAgIGlmICh3aW5kb3cua2V5ID09PSBuZXdTdGF0ZS50cmFuc2Zvcm1LZXkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHggPSBhY3Rpb24ueCAtIG5ld1N0YXRlLnN0YXJ0WDtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZHkgPSBhY3Rpb24ueSAtIG5ld1N0YXRlLnN0YXJ0WTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKG5ld1N0YXRlLnRyYW5zZm9ybVR5cGUgPT09IFRSQU5TRk9STV9NT1ZFKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBwcm9wcy5zdHlsZS50b3AgPSBNYXRoLm1heCgwLCBuZXdTdGF0ZS5zdGFydFRvcCArIGR5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3BzLnN0eWxlLmxlZnQgPSBNYXRoLm1heCgwLCBuZXdTdGF0ZS5zdGFydExlZnQgKyBkeCk7XG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAobmV3U3RhdGUudHJhbnNmb3JtVHlwZSA9PT0gVFJBTlNGT1JNX1JFU0laRSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuc3R5bGUud2lkdGggPSBNYXRoLm1heChERUZBVUxUX1dJRFRILCBuZXdTdGF0ZS5zdGFydFdpZHRoICsgZHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcHJvcHMuc3R5bGUuaGVpZ2h0ID0gTWF0aC5tYXgoREVGQVVMVF9IRUlHSFQsIG5ld1N0YXRlLnN0YXJ0SGVpZ2h0ICsgZHkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLndpbmRvdywgcHJvcHM6IHsgLi4ucHJvcHMsIHN0eWxlOiB7IC4uLnByb3BzLnN0eWxlIH0gfSB9O1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIHR5cGVzLldJTkRPV19NSU5JTUlaRV9BTEw6XG4gICAgICAgICAgICBuZXdTdGF0ZS53aW5kb3dzID0gbmV3U3RhdGUud2luZG93cy5tYXAod2luZG93ID0+IHtcbiAgICAgICAgICAgICAgICB3aW5kb3cucHJvcHMubWluaW1pemVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB3aW5kb3cucHJvcHMuYWN0aXZlID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSB0eXBlcy5XSU5ET1dfRU5EX1RSQU5TRk9STTpcbiAgICAgICAgICAgIG5ld1N0YXRlLnRyYW5zZm9ybUtleSA9IG51bGw7XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBjYXNlIHR5cGVzLlNFVF9GT09URVI6XG4gICAgICAgICAgICBuZXdTdGF0ZS53aW5kb3dzID0gbmV3U3RhdGUud2luZG93cy5tYXAod2luZG93ID0+IHtcbiAgICAgICAgICAgICAgICBpZiAod2luZG93LmtleSA9PT0gYWN0aW9uLmtleSkge1xuICAgICAgICAgICAgICAgICAgICB3aW5kb3cucHJvcHMuZm9vdGVyID0gYWN0aW9uLmZvb3RlcjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIHdpbmRvdztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgY2FzZSB0eXBlcy5TRVRfTE9BRElORzpcbiAgICAgICAgICAgIHZhciBsb2FkaW5nV2luZG93ID0gbmV3U3RhdGUud2luZG93cy5maW5kKHdpbmRvdyA9PiB3aW5kb3cua2V5ID09PSBhY3Rpb24ua2V5KTtcblxuICAgICAgICAgICAgaWYgKGxvYWRpbmdXaW5kb3cpIHtcbiAgICAgICAgICAgICAgICBsb2FkaW5nV2luZG93LmlzTG9hZGluZyA9IGFjdGlvbi5pc0xvYWRpbmc7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIG5ld1N0YXRlLmlzTG9hZGluZyA9IGFjdGlvbi5pc0xvYWRpbmc7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgIGNhc2UgdHlwZXMuU0VUX0RBVEE6XG4gICAgICAgICAgICB2YXIgd2luS2V5ID0gMDtcbiAgICAgICAgICAgIGNvbnN0IGljb25zID0gKGFjdGlvbi5kYXRhLmljb25zIHx8IFtdKTtcbiAgICAgICAgICAgIGNvbnN0IHdpbmRvd3MgPSAoYWN0aW9uLmRhdGEud2luZG93cyB8fCBbXSkubWFwKHdpbmRvdyA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ld1dpbmRvdyh3aW5LZXkrKywgd2luZG93LnByb3BzLCB3aW5kb3cudGVtcGxhdGUsIHdpbmRvdy50ZW1wbGF0ZVByb3BzKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBuZXdTdGF0ZSA9IHtcbiAgICAgICAgICAgICAgICAuLi5pbml0aWFsU3RhdGUsXG4gICAgICAgICAgICAgICAgd2luS2V5LFxuICAgICAgICAgICAgICAgIGljb25zLFxuICAgICAgICAgICAgICAgIHdpbmRvd3NcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBicmVhaztcblxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ld1N0YXRlO1xuXG59XG5cbmV4cG9ydCBkZWZhdWx0IHJlZHVjZXI7Il19